<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat with Delivery + Typing + Timestamps</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      margin: 0;
    }
    #container {
      display: flex;
      width: 900px;
      height: 100vh;
      border: 1px solid #ccc;
    }
    #sidebar {
      width: 200px;
      border-right: 1px solid #ccc;
      padding: 10px;
      background: #f9f9f9;
      overflow-y: auto;
    }
    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }
    #chat {
      flex: 1;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
      margin-bottom: 10px;
    }
    #typingStatus {
      font-style: italic;
      color: gray;
      margin-bottom: 5px;
    }
    input, button {
      padding: 8px;
      margin: 4px;
    }
    .user {
      cursor: pointer;
      padding: 4px;
    }
    .user:hover {
      background-color: #eee;
    }
    .timestamp {
      color: gray;
      font-size: 0.8em;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <h3>ðŸŸ¢ Online Users</h3>
      <div id="users"></div>
    </div>

    <div id="chatArea">
      <div>
        <input id="username" placeholder="Enter username">
        <button id="loginBtn">Login</button>
      </div>

      <div id="chat"></div>
      <div id="typingStatus"></div>

      <div>
        <input id="toUser" placeholder="Send to (username)">
        <input id="message" placeholder="Type message...">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script>
    const socket = new WebSocket('ws://localhost:8080');
    const chat = document.getElementById('chat');
    const usersDiv = document.getElementById('users');
    const typingStatus = document.getElementById('typingStatus');
    let username = '';

    socket.onmessage = (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === 'system') {
        addMessage(`âš™ï¸ ${msg.message}`, 'gray');
      }
      else if (msg.type === 'private_message') {
        addMessage(`ðŸ“© From ${msg.from}: ${msg.message}`, 'black', msg.timestamp);
        showTyping('');
      }
      else if (msg.type === 'user_list') {
        updateUserList(msg.users);
      }
      else if (msg.type === 'delivered') {
        addMessage(`âœ… Delivered to ${msg.to}: ${msg.message}`, 'green', msg.timestamp);
      }
      else if (msg.type === 'typing') {
        showTyping(`${msg.from} is typing...`);
      }
    };

    document.getElementById('loginBtn').onclick = () => {
      username = document.getElementById('username').value.trim();
      if (username) {
        socket.send(JSON.stringify({ type: 'login', username }));
      }
    };

    document.getElementById('sendBtn').onclick = sendMessage;
    document.getElementById('message').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
      else sendTyping();
    });

    function sendMessage() {
      const to = document.getElementById('toUser').value.trim();
      const message = document.getElementById('message').value.trim();
      if (to && message) {
        socket.send(JSON.stringify({ type: 'private_message', to, message }));
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        addMessage(`You â†’ ${to}: ${message}`, 'blue', time);
        document.getElementById('message').value = '';
      }
    }

    function sendTyping() {
      const to = document.getElementById('toUser').value.trim();
      if (to) {
        socket.send(JSON.stringify({ type: 'typing', to }));
      }
    }

    function addMessage(text, color = 'black', time = '') {
      const div = document.createElement('div');
      div.innerHTML = `<span style="color:${color}">${text}</span> <span class="timestamp">(${time})</span>`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function showTyping(text) {
      typingStatus.textContent = text;
      if (text) {
        setTimeout(() => typingStatus.textContent = '', 2000);
      }
    }

    function updateUserList(usernames) {
      usersDiv.innerHTML = '';
      usernames.forEach(user => {
        const div = document.createElement('div');
        div.textContent = user;
        div.className = 'user';
        if (user === username) div.style.fontWeight = 'bold';
        div.onclick = () => {
          document.getElementById('toUser').value = user;
        };
        usersDiv.appendChild(div);
      });
    }
  </script>
</body>
</html>
